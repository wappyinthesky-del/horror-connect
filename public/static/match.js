class MatchManager{constructor(){this.matches=[];this.init()}async init(){this.matchContent=document.getElementById('match-content');await this.loadMatches()}async loadMatches(){try{const response=await fetch('/api/matches');const data=await response.json();this.matches=data.matches||[];this.renderMatches()}catch(error){console.error('ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:',error);if(this.matchContent)this.matchContent.innerHTML='<div class="error-message">ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'}}renderMatches(){if(!this.matchContent)return;if(this.matches.length===0){this.matchContent.innerHTML='<div class="no-matches-message">ãƒãƒƒãƒã—ãŸäººã¯ã„ã¾ã›ã‚“</div>';return}const matchesHtml=this.matches.map(match=>this.renderMatch(match)).join('');this.matchContent.innerHTML=`<div class="matches-list">${matchesHtml}</div>`;this.setupMatchEventListeners()}renderMatch(match){const newLabel=match.isNew?'<span class="new-label">NEW</span>':'';return`<div class="match-item" data-user-id="${match.userId}"><div class="match-avatar"><div class="avatar-placeholder"></div></div><div class="match-info"><div class="match-name">${match.displayName}${newLabel}</div><div class="match-location">${match.prefecture}</div><div class="match-rate">${match.matchPercentage}%</div></div><div class="match-actions"><button class="dm-btn" data-user-id="${match.userId}" title="DMã‚’é€ã‚‹">ğŸ’¬</button></div></div>`}setupMatchEventListeners(){document.querySelectorAll('.dm-btn').forEach(btn=>{btn.addEventListener('click',e=>{const userId=e.currentTarget.getAttribute('data-user-id');this.openDMModal(userId)})})}openDMModal(userId){const match=this.matches.find(m=>m.userId===userId);if(!match)return;const modal=document.createElement('div');modal.className='dm-modal';modal.innerHTML=`<div class="dm-modal-content"><div class="dm-modal-header"><h3>${match.displayName}ã•ã‚“ã«DMã‚’é€ä¿¡</h3><button class="dm-modal-close">&times;</button></div><div class="dm-modal-body"><textarea class="dm-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." maxlength="500"></textarea></div><div class="dm-modal-footer"><button class="dm-send-btn">é€ä¿¡</button><button class="dm-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>`;document.body.appendChild(modal);const closeModal=()=>document.body.removeChild(modal);modal.querySelector('.dm-modal-close').addEventListener('click',closeModal);modal.querySelector('.dm-cancel-btn').addEventListener('click',closeModal);modal.querySelector('.dm-send-btn').addEventListener('click',()=>this.sendDM(userId,modal));modal.addEventListener('click',e=>{if(e.target===modal)closeModal()})}async sendDM(userId,modal){const input=modal.querySelector('.dm-input');const message=input.value.trim();if(!message){alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}const sendBtn=modal.querySelector('.dm-send-btn');try{sendBtn.disabled=true;sendBtn.textContent='é€ä¿¡ä¸­...';const formData=new FormData();formData.append('recipient',userId);formData.append('message',message);const response=await fetch('/api/dm/send',{method:'POST',body:formData});const result=await response.json();if(result.success){document.body.removeChild(modal);alert('DMã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');this.notifyDMSent()}else{alert(result.error||'DMé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ')}}catch(error){console.error('DMé€ä¿¡ã‚¨ãƒ©ãƒ¼:',error);alert('DMé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ')}finally{sendBtn.disabled=false;sendBtn.textContent='é€ä¿¡'}}notifyDMSent(){const dmTab=document.querySelector('[data-tab="dm"]');if(dmTab){dmTab.classList.add('has-notification')}}}document.addEventListener('DOMContentLoaded',function(){let matchManager=null;function initMatchIfActive(){const matchTab=document.getElementById('match-tab');if(matchTab&&matchTab.classList.contains('active')&&!matchManager)matchManager=new MatchManager()}document.querySelectorAll('.nav-item').forEach(navItem=>{navItem.addEventListener('click',function(){const tabName=this.getAttribute('data-tab');setTimeout(()=>{if(tabName==='match')initMatchIfActive()},100)})})});