# HorrorConnect 👻

## プロジェクト概要
- **名前**: HorrorConnect
- **目標**: ホラー好きのためのソーシャルWebアプリ
- **特徴**: フィード機能、マッチング、掲示板システム、DM機能を備えた軽量コミュニティプラットフォーム

## 現在実装済みの機能
### ✅ 認証・プロフィール系
- パスワード保護機能（セッション管理）
- ユーザー登録・ログイン機能 
- プロフィール設定（基本情報・ホラー好み詳細設定）
- デバッグユーザー自動初期化（PM2再起動対応）

### ✅ フィード機能
- 投稿作成（テキスト + 画像圧縮機能）
- フィード表示（マッチング度50%以上のユーザー投稿）
- 返信機能（投稿への返信・表示）
- ブックマーク機能（投稿の保存・解除）
- メモリ効率化（軽量JavaScript実装）

### ✅ マッチングシステム
- ホラー好みアルゴリズム（詳細なジャンル・媒体マッチング）
- 50%以上マッチ閾値でフィード表示制御
- マッチ率表示（パーセンテージ表示）
- NEWラベル表示（新規ユーザー判定）

### ✅ 掲示板システム（NEW！）
- **メモリ効率重視**の軽量実装
- 掲示板作成機能（タイトル・初期投稿・画像対応）
- 掲示板一覧表示（投稿数・作成日時表示）
- 個別掲示板詳細画面（ナビゲーション非表示機能）
- 掲示板投稿機能（テキスト・画像圧縮対応）
- **掲示板投稿ブックマーク機能**（各投稿に☆/★ボタン）
- **50+投稿で自動折りたたみ機能**
- 画像圧縮再利用（フィードシステム流用）

### ✅ DM機能（NEW！完全実装）
- **本人認証ゲートシステム**: 未認証ユーザーはDMアクセス時に認証画面へリダイレクト
- **アイデンティティ本人認証**: 「このサービスの利用には本人認証が必要です。本人認証を行いますか？」プロンプト画面
- **DMトーク一覧**: 送信者のアバター・表示名付き会話リスト
- **プロフィール統合**: アバタークリック → プロフィール画面、名前クリック → チャット画面
- **ブロック・削除機能**: 会話削除・ユーザーブロック機能完備
- **チャット画面**: リアルタイムメッセージ送受信、戻るボタン機能
- **マッチタブ連携**: マッチ画面からのDM送信機能（予定）

### ✅ イベント機能（NEW！）
- **本人認証ゲートシステム**: 未認証ユーザーはイベント作成時に認証画面へリダイレクト
- **イベント作成機能**: 日時・内容・定員・参考リンク設定対応
- **イベント参加機能**: 定員管理・参加済み表示・満員表示
- **イベント募集終了機能**: 作成者のみ利用可能
- **イベントブックマーク機能**: 各イベントに☆/★ボタン付き
- **過去イベント自動削除**: メモリ効率化のため終了24時間後に自動削除

### ✅ ブックマーク機能（NEW！完全実装）
- **統合ブックマーク表示**: フィード・イベント・掲示板のブックマークを一元表示
- **カテゴリフィルター**: すべて・フィード・イベント・掲示板で絞り込み可能
- **元投稿へのリンク**: 🔗ボタンで該当タブの元投稿に直接移動
- **削除済み投稿の自動処理**: 元投稿が削除された場合、ブックマークも自動で非表示
- **タイプ別バッジ表示**: 投稿種別を色分けバッジで分かりやすく表示
- **時系列ソート**: 最新のブックマークから順に表示

### ✅ UI/UX
- モバイルファーストデザイン（レスポンシブ対応）
- タブ式ナビゲーション（フィード・マッチ・イベント・掲示板・DM・ブクマ）
- 軽量PNG ゴーストキャラクター
- CSS最適化（ファイル分割・バージョン管理）

## 機能的なエントリURI・パラメータ
### 基本認証系
- `GET /` - メインアプリ（認証済みユーザーのみ）
- `GET /welcome` - ウェルカムページ
- `POST /welcome-login` - ログイン認証（userid, password）
- `GET /register` - 新規登録ページ
- `POST /register` - 新規登録処理（userid, password, confirm_password）
- `GET /profile-setup` - 基本プロフィール設定
- `POST /profile-setup` - プロフィール保存（display_name, birth_date, gender, prefecture, self_introduction）

### ホラー好み設定
- `GET /horror-preferences` - ホラー好み詳細設定
- `POST /horror-preferences` - ホラー好み保存（media_types[], genre_types[], ng_types[], ghost_belief, story_belief, paranormal_activity）

### フィード系API
- `GET /api/feed` - フィード取得（マッチング度50%以上フィルタリング）
- `POST /api/posts` - 投稿作成（FormData: content, image?）
- `POST /api/posts/:postId/replies` - 返信投稿（FormData: content）
- `POST /api/posts/:postId/bookmark` - ブックマーク追加/削除

### マッチング系API
- `GET /api/matches` - マッチングユーザー一覧取得

### 掲示板系API（NEW！）
- `GET /api/boards` - 掲示板一覧取得
- `POST /api/boards` - 掲示板作成（FormData: title, content, image?）
- `GET /api/boards/:boardId` - 個別掲示板取得
- `POST /api/boards/:boardId/posts` - 掲示板投稿（FormData: content, image?）
- `POST /api/boards/:boardId/posts/:postId/bookmark` - 掲示板投稿ブックマーク追加/削除

### DM系API（NEW！完全実装）
- `GET /api/dm/conversations` - DM会話一覧取得（本人認証チェック付き）
- `POST /api/dm/conversations/:userId/messages` - メッセージ送信（FormData: message）
- `GET /api/dm/conversations/:userId/messages` - 特定ユーザーとのメッセージ履歴取得
- `DELETE /api/dm/conversations/:userId` - 会話削除
- `POST /api/dm/block/:userId` - ユーザーブロック
- `DELETE /api/dm/block/:userId` - ブロック解除
- `GET /api/users/:userId/profile` - ユーザープロフィール取得（DM統合）

### イベント系API（NEW！）
- `GET /api/events` - イベント一覧取得（過去イベント自動削除）
- `POST /api/events` - イベント作成（FormData: eventDate, content, capacity, referenceLink?）
- `POST /api/events/:eventId/close` - イベント募集終了（作成者のみ）
- `POST /api/events/:eventId/join` - イベント参加
- `POST /api/events/:eventId/bookmark` - イベントブックマーク追加/削除

### ブックマーク系API（NEW！）
- `GET /api/bookmarks` - 統合ブックマーク一覧取得（フィード・イベント・掲示板）

### 本人認証系API（NEW！）
- `GET /api/identity-verification/status` - 本人認証状態確認
- `POST /api/identity-verification` - 本人認証申請（FormData: document）
- `POST /api/identity-verification/auto-approve` - デバッグ用自動承認

### デバッグ系（開発環境限定）
- `GET /debug/users?debug_key=horror_debug_2024` - ユーザー状態確認
- `POST /debug/reinit-users?debug_key=horror_debug_2024` - ユーザー再初期化
- `POST /debug/emergency-recovery?debug_key=horror_debug_2024` - 緊急データ復旧
- `GET /debug/system-status?debug_key=horror_debug_2024` - システム状態監視

## まだ実装されていない機能
- ❌ マッチタブからのDM送信ボタン機能（DMシステム本体は完成済み）
- ❌ プロフィール編集機能
- ❌ 本格的なCloudflare D1データベース連携
- ❌ プロダクション環境デプロイ
- ❌ 通知システム
- ❌ 管理機能

## 推奨される次のステップ
1. **マッチタブDM送信機能の実装**（マッチ画面でのDMボタン機能追加）
2. **全機能の統合テスト**（ブックマーク・DM・イベント機能動作確認）
3. **プロフィール編集機能の実装**（ユーザー情報・ホラー好み更新）
4. **Cloudflare D1データベース導入**（現在はメモリ内データ）
5. **画像ストレージ最適化**（Cloudflare R2連携）
6. **プロダクション環境デプロイ**

## URL
- **開発環境**: https://3000-itxt8e1lemvt4494ldvyl-6532622b.e2b.dev
- **ログイン**: https://3000-itxt8e1lemvt4494ldvyl-6532622b.e2b.dev/welcome
- **GitHub**: （後日設定予定）

## データアーキテクチャ
### 現在のデータ構造
- **ユーザー**: Map<userid, {userid, password, profile, horrorPreferences, identityVerified, createdAt}>
- **投稿**: Map<postId, {id, userid, content, image?, timestamp, replies[], bookmarkedBy[]}>
- **掲示板**: Map<boardId, {id, title, creatorId, posts[], createdAt}>
- **DM**: Array<{id, senderId, recipientId, message, timestamp, read}>
- **本人認証**: Map<verificationId, {id, userId, documentImage, status, submittedAt}>
- **ブロックユーザー**: Map<userId, Set<blockedUserId>>
- **削除されたトーク**: Map<userId, Set<otherUserId>>

### ストレージサービス（予定）
- **Cloudflare D1**: リレーショナルデータ（ユーザー・投稿・掲示板）
- **Cloudflare R2**: 画像・ファイルストレージ
- **Cloudflare KV**: セッション・キャッシュデータ

### データフロー
- フィード: マッチングアルゴリズム → フィルタリング → 時系列ソート
- 掲示板: メモリ効率優先 → 50+投稿で折りたたみ → 画像圧縮

## ユーザーガイド

### 🔐 ログイン方法（デバッグユーザー）
1. https://3000-itxt8e1lemvt4494ldvyl-6532622b.e2b.dev/welcome にアクセス
2. 以下のデバッグユーザーでログイン:
   - **ユーザーID**: `debug_user1` **パスワード**: `password123`
   - **ユーザーID**: `debug_user2` **パスワード**: `password456`
   - **ユーザーID**: `debug_user3` **パスワード**: `password789`

### 📱 基本操作ガイド
1. **フィードタブ**: 投稿作成・閲覧、返信、ブックマーク
2. **マッチタブ**: ホラー好みが合う人を探す・DM送信
3. **イベントタブ**: イベント作成・参加・ブックマーク機能
4. **掲示板タブ**: 掲示板作成・投稿・閲覧
5. **DMタブ**: 本人認証付きプライベートメッセージ・ブロック・削除機能
6. **ブックマークタブ**: 全機能のブックマーク統合表示・元投稿リンク

### 🗂️ 掲示板システム使用方法
1. **掲示板作成**: 掲示板タブ → タイトル・内容入力 → 画像添付（任意） → 作成
2. **掲示板閲覧**: 掲示板一覧から興味のある掲示板をクリック
3. **投稿**: 掲示板詳細画面 → 下部の投稿エリア → 内容入力 → 投稿
4. **画像添付**: 📷ボタンをクリック → 画像選択（自動圧縮）
5. **ブックマーク**: 各投稿の右上にある☆ボタンをクリック → ★に変わり、ブックマーク登録完了
6. **50+投稿折りたたみ**: 投稿数が50を超えると自動で古い投稿が折りたたまれ、トグルボタンで表示/非表示切替可能

### 📅 イベントシステム使用方法（NEW！）
1. **イベント作成**: イベントタブ → 本人認証完了 → 日時・内容・定員・参考リンク入力 → 作成
2. **イベント参加**: イベント一覧から参加したいイベントの「参加する」ボタンをクリック
3. **ブックマーク**: 各イベントの右上にある☆ボタンをクリック → ★に変わり、ブックマーク登録完了
4. **募集終了**: イベント作成者のみ「募集終了」ボタンで募集を締め切ることが可能
5. **参加状況確認**: 参加者数/定員数、参加済み表示、満員表示で状況を確認
6. **参考リンク**: イベント詳細にある🔗参考リンクから関連情報を確認（新しいタブで開く）

### 🔖 ブックマークシステム使用方法（NEW！）
1. **ブックマーク一覧**: ブックマークタブで全機能（フィード・イベント・掲示板）のブックマーク投稿を統合表示
2. **カテゴリフィルター**: 上部のフィルターボタンで「すべて」「フィード」「イベント」「掲示板」に絞り込み
3. **元投稿への移動**: 各ブックマーク項目の🔗ボタンをクリック → 該当タブの元投稿に自動移動
4. **タイプ識別**: 色分けされたバッジ（緑：フィード、青：イベント、オレンジ：掲示板）で投稿種別を確認
5. **時系列表示**: 最新にブックマークした投稿から順に時系列で表示
6. **自動クリーンアップ**: 元投稿が削除された場合、該当ブックマークは自動的に一覧から除外

### 💬 DMシステム使用方法（NEW！）
1. **初回アクセス**: DMタブクリック → 「このサービスの利用には本人認証が必要です。本人認証を行いますか？」 → 本人認証へ
2. **本人認証**: 本人認証ページで身分証明書画像をアップロード → 審査完了まで待機（デバッグ環境では自動承認可能）
3. **トーク一覧**: 認証完了後、DMタブでトーク一覧表示（送信者アバター・名前・最新メッセージプレビュー）
4. **チャット開始**: 
   - アバターをクリック → ユーザープロフィール表示
   - 名前・テーブルエリアをクリック → チャット画面へ
5. **メッセージ送信**: チャット画面下部の入力エリア → メッセージ入力 → 送信ボタン
6. **会話管理**: 
   - 🗑️削除ボタン → 会話を削除（自分の履歴から削除）
   - 🚫ブロックボタン → ユーザーをブロック（相手からのメッセージ受信拒否）
7. **プロフィール連携**: プロフィール画面からDM送信ボタンでチャット開始可能

### 🎯 マッチングシステム
- **自動マッチング**: ホラー好み（媒体・ジャンル・NG項目・信念）を基に自動計算
- **50%以上マッチ**: マッチ率50%以上のユーザーの投稿のみフィードに表示
- **詳細アルゴリズム**: 
  - 媒体タイプ一致度（重み30%）
  - ジャンル一致度（重み40%）
  - 信念・体験意向一致度（重み各10%）
  - NG項目は減点要素（-15%/項目）

## デプロイメント
- **プラットフォーム**: Cloudflare Pages
- **ステータス**: ✅ 開発環境稼働中
- **技術スタック**: Hono + TypeScript + TailwindCSS + PM2
- **パフォーマンス**: メモリ効率化・軽量JavaScript・画像圧縮対応
- **最終更新**: 2025-08-25 (ブックマークタブ統合機能実装完了)

## 開発者向け情報
### 🔧 セットアップ・起動方法
```bash
# 依存関係インストール
npm install

# 開発環境ビルド
npm run build

# PM2でサービス開始（推奨）
pm2 start ecosystem.config.cjs

# サービス確認
curl http://localhost:3000/welcome
```

### 📊 メモリ効率化対策
- Map構造によるデータ管理
- 画像自動圧縮（Canvas API使用）
- 投稿50+で自動折りたたみ機能
- イベントドリブン設計（無駄なデータ保持を回避）
- CSS・JavaScript分割・最適化

### 🐛 デバッグ機能
- PM2再起動対応の自動データ復旧
- デバッグエンドポイント群（/debug/*）
- システム状態監視・ユーザー状態確認機能
- 緊急復旧機能（全データ再初期化）